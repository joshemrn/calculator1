<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pricing Formula Calculator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-12">
  <div class="w-full max-w-5xl mx-auto px-4">
    <header class="mb-8">
      <a href="index.html" class="inline-flex items-center gap-2 text-sm text-indigo-600 hover:underline mb-4">Home</a>
      <h1 class="text-4xl font-bold text-slate-800">Pricing Formula Calculator</h1>
      <p class="text-slate-600 mt-2">Cost input in selected currency. For USD, cost is entered in USD and sale prices are shown in CAD using a live exchange rate. No fixed fees. Defaults match the provided screenshot.</p>
    </header>

    <main>
      <div class="bg-white rounded-2xl shadow-lg p-8">
        <div class="mb-6">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Currency</label>
          <div class="flex gap-4">
            <button id="currency-cad" class="flex-1 py-2 px-3 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-semibold" aria-pressed="true">CAD</button>
            <button id="currency-usd" class="flex-1 py-2 px-3 rounded-lg border-2 border-gray-300 bg-white text-slate-600 font-semibold" aria-pressed="false">USD</button>
          </div>
          <div id="exchange-rate-display" class="hidden mt-3 text-sm text-green-700">Live: <span id="exchange-rate-value">1.40</span> CAD per 1 USD â€” <button id="refresh-rate-btn" class="underline text-green-700">Refresh</button>
            <div id="rate-timestamp" class="text-xs text-green-600 mt-1">Updated now</div>
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Cost (base)</label>
          <div class="flex items-center gap-2">
            <span id="currency-symbol" class="text-lg font-bold">$</span>
            <input id="cost-input" type="number" step="0.01" min="0" class="flex-1 px-3 py-2 border rounded" placeholder="Enter cost">
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Margins (editable)</label>
          <div class="grid grid-cols-4 gap-3">
            <input id="margin-a" type="number" value="20" step="0.1" class="px-2 py-2 border rounded" aria-label="Price A margin">
            <input id="margin-b" type="number" value="25" step="0.1" class="px-2 py-2 border rounded" aria-label="Price B margin">
            <input id="margin-c" type="number" value="30" step="0.1" class="px-2 py-2 border rounded" aria-label="Price C margin">
            <input id="margin-website" type="number" value="37" step="0.1" class="px-2 py-2 border rounded" aria-label="Website margin">
          </div>
        </div>

        <div class="flex gap-3">
          <button id="calculate-btn" class="px-4 py-2 bg-indigo-600 text-white rounded">Calculate</button>
          <button id="reset-btn" class="px-4 py-2 bg-gray-200 rounded">Reset</button>
        </div>

        <div id="results" class="mt-6 hidden">
          <h3 class="text-lg font-bold mb-3">Results (CAD)</h3>
          <div class="mb-2">Converted cost: <span id="converted-cost">$0.00</span></div>
          <div class="mb-2">Total (after shipping): <span id="total-cost">$0.00</span></div>
          <div class="mt-4 grid grid-cols-1 gap-3">
            <div>A (margin): <span id="price-a">$0.00</span></div>
            <div>B (margin): <span id="price-b">$0.00</span></div>
            <div>C (margin): <span id="price-c">$0.00</span></div>
            <div>Website (margin): <span id="price-website">$0.00</span></div>
          </div>
        </div>
      </div>
    </main>

  </div>

  <script>
    // Basic DOM refs
    const costInput = document.getElementById('cost-input');
    const currencyCadBtn = document.getElementById('currency-cad');
    const currencyUsdBtn = document.getElementById('currency-usd');
    const currencySymbol = document.getElementById('currency-symbol');
    const exchangeRateDisplay = document.getElementById('exchange-rate-display');
    const exchangeRateValue = document.getElementById('exchange-rate-value');
    const rateTimestamp = document.getElementById('rate-timestamp');
    const refreshRateBtn = document.getElementById('refresh-rate-btn');
    const calculateBtn = document.getElementById('calculate-btn');
    const resetBtn = document.getElementById('reset-btn');
    const results = document.getElementById('results');
    const convertedCostEl = document.getElementById('converted-cost');
    const totalCostEl = document.getElementById('total-cost');
    const priceAEl = document.getElementById('price-a');
    const priceBEl = document.getElementById('price-b');
    const priceCEl = document.getElementById('price-c');
    const priceWebsiteEl = document.getElementById('price-website');

    const marginA = document.getElementById('margin-a');
    const marginB = document.getElementById('margin-b');
    const marginC = document.getElementById('margin-c');
    const marginWebsite = document.getElementById('margin-website');

    let currentCurrency = 'CAD';
    let exchangeRate = 1.4; // default

    // Set currency UI
    function setCurrency(c) {
      currentCurrency = c;
      if (c === 'CAD') {
        currencyCadBtn.classList.add('border-blue-500');
        currencyUsdBtn.classList.remove('border-blue-500');
        currencySymbol.textContent = '$';
        exchangeRateDisplay.classList.add('hidden');
      } else {
        currencyUsdBtn.classList.add('border-blue-500');
        currencyCadBtn.classList.remove('border-blue-500');
        currencySymbol.textContent = 'US$';
        exchangeRateDisplay.classList.remove('hidden');
      }
    }

    currencyCadBtn.addEventListener('click', () => setCurrency('CAD'));
    currencyUsdBtn.addEventListener('click', () => setCurrency('USD'));
    refreshRateBtn.addEventListener('click', fetchExchangeRate);
    calculateBtn.addEventListener('click', calculate);
    resetBtn.addEventListener('click', resetForm);

    // Fetch exchange rate (USD -> CAD)
    async function fetchExchangeRate() {
      try {
        refreshRateBtn.disabled = true;
        refreshRateBtn.textContent = 'Loading...';
        const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=CAD');
        const data = await res.json();
        if (data && data.rates && data.rates.CAD) {
          exchangeRate = parseFloat(data.rates.CAD);
          exchangeRateValue.textContent = exchangeRate.toFixed(4);
          rateTimestamp.textContent = `Updated ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
          localStorage.setItem('pricing_exchange_rate', exchangeRate);
          localStorage.setItem('pricing_exchange_time', new Date().toISOString());
        }
      } catch (err) {
        console.error(err);
      } finally {
        refreshRateBtn.disabled = false;
        refreshRateBtn.textContent = 'Refresh';
      }
    }

    function loadCachedRate() {
      const cached = localStorage.getItem('pricing_exchange_rate');
      const t = localStorage.getItem('pricing_exchange_time');
      if (cached) {
        exchangeRate = parseFloat(cached);
        exchangeRateValue.textContent = exchangeRate.toFixed(4);
        if (t) rateTimestamp.textContent = `Updated ${new Date(t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
      }
    }

    // Calculation: remove fixed fees, follow screenshot
    function calculate() {
      const costRaw = parseFloat(costInput.value);
      if (isNaN(costRaw) || costRaw <= 0) {
        alert('Enter a positive cost');
        return;
      }

      let costCAD;
      if (currentCurrency === 'CAD') {
        costCAD = costRaw;
      } else {
        // costRaw is USD, convert to CAD
        costCAD = costRaw * exchangeRate;
      }

      // Apply shipping: CAD 3% for CAD, USD uses 4% (applied after conversion)
      const shippingRate = currentCurrency === 'CAD' ? 0.03 : 0.04;
      const totalCost = costCAD * (1 + shippingRate);

      // Margins (user inputs are percentages)
      const ma = parseFloat(marginA.value) / 100;
      const mb = parseFloat(marginB.value) / 100;
      const mc = parseFloat(marginC.value) / 100;
      const mw = parseFloat(marginWebsite.value) / 100;

      const priceA = totalCost / (1 - ma);
      const priceB = totalCost / (1 - mb);
      const priceC = totalCost / (1 - mc);
      const priceW = totalCost / (1 - mw);

      // Display (always show CAD values for sale prices)
      convertedCostEl.textContent = '$' + costCAD.toFixed(2);
      totalCostEl.textContent = '$' + totalCost.toFixed(2);
      priceAEl.textContent = '$' + priceA.toFixed(2);
      priceBEl.textContent = '$' + priceB.toFixed(2);
      priceCEl.textContent = '$' + priceC.toFixed(2);
      priceWebsiteEl.textContent = '$' + priceW.toFixed(2);
      results.classList.remove('hidden');

      // Save to history (simple)
      const history = JSON.parse(localStorage.getItem('pricing_history') || '[]');
      history.unshift({currency: currentCurrency, inputCost: costRaw, costCAD: costCAD, totalCost: totalCost, prices: {a: priceA, b: priceB, c: priceC, website: priceW}, time: new Date().toISOString()});
      localStorage.setItem('pricing_history', JSON.stringify(history.slice(0,20)));
    }

    function resetForm() {
      costInput.value = '';
      marginA.value = '20';
      marginB.value = '25';
      marginC.value = '30';
      marginWebsite.value = '37';
      results.classList.add('hidden');
    }

    // init
    loadCachedRate();
    fetchExchangeRate();
    setCurrency('CAD');
  </script>
</body>
</html>